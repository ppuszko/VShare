<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .category-pill.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        
        /* Disabled state for search button */
        #searchBtn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden flex flex-col">

    <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between z-10">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-gray-900 tracking-tight">Intelligence <span class="text-blue-600">Search</span></h1>
        </div>
        <button onclick="loadView('home.html')" class="text-sm font-medium text-gray-500 hover:text-blue-600 transition">‚Üê Back to Dashboard</button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-72 bg-white border-r border-gray-200 p-6 flex flex-col gap-8 overflow-y-auto custom-scrollbar">
            
            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Time Frame</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">From</label>
                        <input type="date" id="dateStart" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">To</label>
                        <input type="date" id="dateEnd" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Categories</h3>
                <div id="categoryContainer" class="flex flex-wrap gap-2">
                    <p class="text-xs text-gray-400 italic">Loading categories...</p>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Preferences</h3>
                <label class="flex items-center cursor-pointer group">
                    <input type="checkbox" id="onlyMyArticles" class="sr-only peer">
                    <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-colors after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                    <span class="ml-3 text-sm text-gray-600 group-hover:text-gray-900 transition">My Articles Only</span>
                </label>
            </div>

            <button id="searchBtn" disabled class="mt-auto w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100">
                Search
            </button>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
            
            <div class="p-8 bg-white border-b border-gray-100">
                <div class="max-w-4xl mx-auto relative">
                    <input type="text" id="searchInput" placeholder="Ask your data anything..." 
                           class="w-full pl-14 pr-4 py-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:bg-white focus:ring-4 focus:ring-blue-50/50 focus:border-blue-200 text-lg transition shadow-inner">
                    <svg class="w-6 h-6 text-gray-400 absolute left-5 top-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <div id="resultsWrapper" class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <div id="resultsList" class="max-w-4xl mx-auto space-y-6">
                    <div class="text-center py-20 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18 18.247 18.477 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        <p class="italic text-lg">Your intelligence is ready. Just type a query.</p>
                    </div>
                </div>

                <div id="loader" class="hidden py-10 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
                    <p class="text-gray-500 mt-4 font-medium">Scanning vector embeddings...</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { apiRequest } from './api.js';

        const resultsList = document.getElementById('resultsList');
        const loader = document.getElementById('loader');
        const categoryContainer = document.getElementById('categoryContainer');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        let categoryMap = {}; 
        let selectedCategories = new Set();

        // Download handler using apiRequest to include Auth token
        window.downloadFile = async (fileName) => {
            try {
                const res = await apiRequest(`/download/${fileName}`);
                if (res && res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName; // Triggers download dialog
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert("Download failed: Unauthorized or file not found.");
                }
            } catch (err) {
                console.error("Download error:", err);
            }
        };

        async function loadCategories() {
            const res = await apiRequest("/fetch-categories");
            if (res && res.ok) {
                categoryMap = await res.json();
                categoryContainer.innerHTML = '';
                Object.entries(categoryMap).forEach(([id, name]) => {
                    const pill = document.createElement('button');
                    pill.className = "category-pill px-3 py-1.5 border border-gray-200 rounded-full text-xs font-medium text-gray-600 hover:border-blue-300 hover:bg-blue-50 transition";
                    pill.textContent = name;
                    pill.onclick = () => {
                        if (selectedCategories.has(id)) {
                            selectedCategories.delete(id);
                            pill.classList.remove('active');
                        } else {
                            selectedCategories.add(id);
                            pill.classList.add('active');
                        }
                    };
                    categoryContainer.appendChild(pill);
                });
            }
        }

        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            resultsList.innerHTML = '';
            loader.classList.remove('hidden');

            const queryFilters = {
                time_frame: [
                    document.getElementById('dateStart').value || null,
                    document.getElementById('dateEnd').value || null
                ],
                category_id: selectedCategories.size > 0 ? Array.from(selectedCategories).map(Number) : null,
                only_my_articles: document.getElementById('onlyMyArticles').checked 
            };

            const params = new URLSearchParams({
                query: query,
                query_filters: JSON.stringify(queryFilters)
            });

            try {
                const res = await apiRequest(`/search?${params.toString()}`);
                loader.classList.add('hidden');
                if (res && res.ok) {
                    const data = await res.json();
                    renderResults(data);
                }
            } catch (err) {
                loader.classList.add('hidden');
                resultsList.innerHTML = `<p class="text-red-500 text-center">Search failed.</p>`;
            }
        }

        function renderResults(results) {
            if (results.length === 0) {
                resultsList.innerHTML = `<div class="text-center py-20 bg-white rounded-2xl border border-dashed text-gray-400">No matching documents found.</div>`;
                return;
            }

            results.forEach((item, index) => {
                const catName = categoryMap[item.category_id] || "General";
                const date = new Date(item.created_at).toLocaleDateString();
                
                const card = document.createElement('div');
                card.className = "group bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-100 transition-all p-6";
                card.innerHTML = `
                    <div class="flex flex-col gap-4">
                        <div class="flex items-start justify-between">
                            <div class="space-y-1">
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] font-black bg-blue-600 text-white px-2 py-0.5 rounded italic">RANK ${index + 1}</span>
                                    <span class="text-xs font-bold text-blue-500 uppercase tracking-tighter">${catName}</span>
                                </div>
                                <h2 class="text-lg font-bold text-gray-900 group-hover:text-blue-600 transition">${item.title || 'Untitled Document'}</h2>
                                <p class="text-xs text-gray-400">${date}</p>
                            </div>
                            <div>
                                <button onclick="downloadFile('${item.file_name}')" 
                                        class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-600 hover:text-white transition">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    DOWNLOAD
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                            <p class="text-gray-600 text-sm leading-relaxed italic">"...${item.chunk_text}..."</p>
                        </div>
                    </div>
                `;
                resultsList.appendChild(card);
            });
        }

        // Toggle button state based on input
        searchInput.oninput = () => {
            searchBtn.disabled = searchInput.value.trim().length === 0;
        };

        searchBtn.onclick = performSearch;
        searchInput.onkeypress = (e) => { 
            if(e.key === 'Enter' && !searchBtn.disabled) performSearch(); 
        };

        loadCategories();
    </script>
</body>
</html>